name: Release

# Triggered by pushing a semantic version tag, e.g.:
#   git tag v1.2.3 && git push origin v1.2.3
# Pre-release tags (containing '-') are published as GitHub pre-releases:
#   v1.2.0-rc1, v1.2.0-beta2, v1.2.0-alpha1
on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write   # Required to create a GitHub Release

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest

    steps:
      # ── 1. 拉取完整历史（用于生成 CHANGELOG） ─────────────────
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── 2. 配置 JDK ───────────────────────────────────────────
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ── 3. 从 tag 解析版本号 ──────────────────────────────────
      - name: Extract version from tag
        id: version
        run: |
          # Remove leading 'v': v1.2.3 → 1.2.3
          TAG="${GITHUB_REF_NAME#v}"
          echo "version_name=$TAG" >> "$GITHUB_OUTPUT"

          # Compute versionCode: major*10000 + minor*100 + patch
          # e.g.  1.2.3  →  10203   |   2.0.0  →  20000
          IFS='.' read -r MAJOR MINOR PATCH <<< "${TAG%%-*}"   # strip pre-release suffix
          VERSION_CODE=$(( MAJOR * 10000 + MINOR * 100 + PATCH ))
          echo "version_code=$VERSION_CODE" >> "$GITHUB_OUTPUT"

          echo "version_name : $TAG"
          echo "version_code : $VERSION_CODE"

      # ── 4. 解码 Keystore（Secret 缺失时跳过，构建未签名 APK）────
      - name: Decode keystore
        id: keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > keystore.jks
            echo "KEYSTORE_PATH=${{ github.workspace }}/keystore.jks" >> "$GITHUB_ENV"
            echo "signed=true" >> "$GITHUB_OUTPUT"
            echo "Keystore decoded. APK will be signed."
          else
            echo "signed=false" >> "$GITHUB_OUTPUT"
            echo "No KEYSTORE_BASE64 secret found. APK will be unsigned."
          fi

      # ── 5. 代码质量检查 ───────────────────────────────────────
      - name: Run ktlint
        run: ./gradlew ktlintCheck

      # ── 6. 构建 Release APK ───────────────────────────────────────────
      - name: Build Release APK
        run: ./gradlew assembleRelease
        env:
          VERSION_NAME: ${{ steps.version.outputs.version_name }}
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
          # 签名参数：空展时 build.gradle.kts 自动跳过签名
          KEYSTORE_PATH: ${{ env.KEYSTORE_PATH }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # ── 7. 重命名 APK（已签名/未签名 区分后缀）────────────────────
      - name: Rename APK
        id: apk
        run: |
          APK_DIR="app/build/outputs/apk/release"
          VER="${{ steps.version.outputs.version_name }}"
          if [ "${{ steps.keystore.outputs.signed }}" = "true" ]; then
            NEW_NAME="MedLog-v${VER}.apk"
          else
            NEW_NAME="MedLog-v${VER}-unsigned.apk"
          fi
          find "$APK_DIR" -name "*.apk" | head -1 | xargs -I{} mv {} "$APK_DIR/$NEW_NAME"
          echo "apk_name=$NEW_NAME" >> "$GITHUB_OUTPUT"
          echo "APK: $NEW_NAME"

      # ── 7. 生成 CHANGELOG（自上一个 tag 以来的提交） ─────────
      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-creatordate \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' \
            | sed -n '2p')
          if [ -n "$PREV_TAG" ]; then
            LOG=$(git log "$PREV_TAG"..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            LOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          fi
          {
            echo "changelog<<EOF"
            echo "$LOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # ── 8. 发布 GitHub Release，附带 APK ─────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "MedLog v${{ steps.version.outputs.version_name }}"
          body: |
            ## 更新内容

            ${{ steps.changelog.outputs.changelog }}

            ---
            **版本信息**
            | 项目 | 值 |
            |------|-----|
            | versionName | `${{ steps.version.outputs.version_name }}` |
            | versionCode | `${{ steps.version.outputs.version_code }}` |
            | 构建号 | `#${{ github.run_number }}` |
            | Commit | ${{ github.sha }} |

            > ⚠️ 此 APK **未正式签名**，仅供开发/测试使用。正式发布前需配置 Release 签名。
          files: app/build/outputs/apk/release/${{ steps.apk.outputs.apk_name }}
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
