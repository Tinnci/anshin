#!/usr/bin/env zsh
# setup-signing.sh â€” åœ¨æ–° Mac ä¸Šä¸€é”®æ¢å¤ Release ç­¾åé…ç½®
#
# å‰æï¼ˆæ¢æœºå™¨åŽ iCloud åŒæ­¥å®Œæˆå³å·²æ»¡è¶³ï¼‰ï¼š
#   1. iCloud Drive å·²åŒæ­¥ ~/Library/Mobile Documents/com~apple~CloudDocs/Dev/Keystores/medlog-release.jks
#   2. iCloud Keychain å·²åŒæ­¥å¯†ç æ¡ç›® (æœåŠ¡: MedLogAndroid-Keystore)
#
# ç”¨æ³•ï¼š
#   chmod +x scripts/setup-signing.sh
#   ./scripts/setup-signing.sh

set -e

ICLOUD_JKS="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Dev/Keystores/medlog-release.jks"
KEYCHAIN_SERVICE="MedLogAndroid-Keystore"
KEYCHAIN_ACCOUNT="release"
LOCAL_PROPS="$(dirname "$0")/../local.properties"

echo "ðŸ”‘ MedLog Release ç­¾åé…ç½®åˆå§‹åŒ–"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# 1. æ£€æŸ¥ keystore æ–‡ä»¶
if [ ! -f "$ICLOUD_JKS" ]; then
  echo "âŒ æ‰¾ä¸åˆ° keystore æ–‡ä»¶ï¼š$ICLOUD_JKS"
  echo "   è¯·ç¡®è®¤ iCloud Drive å·²åŒæ­¥å®Œæˆï¼Œæˆ–æ‰‹åŠ¨å°† .jks æ–‡ä»¶æ”¾åˆ°ä¸Šè¿°è·¯å¾„ã€‚"
  exit 1
fi
echo "âœ… Keystoreï¼š$ICLOUD_JKS"

# 2. ä»Ž macOS Keychain è¯»å–å¯†ç 
PASS=$(security find-generic-password \
  -a "$KEYCHAIN_ACCOUNT" \
  -s "$KEYCHAIN_SERVICE" \
  -w 2>/dev/null || true)

if [ -z "$PASS" ]; then
  echo "âš ï¸  Keychain ä¸­æœªæ‰¾åˆ°å¯†ç  (æœåŠ¡: $KEYCHAIN_SERVICE)"
  echo -n "   è¯·æ‰‹åŠ¨è¾“å…¥ Keystore å¯†ç å¹¶æŒ‰ Enterï¼š"; read -rs PASS; echo
  # é¡ºä¾¿å­˜å…¥æœ¬æœº Keychain
  security add-generic-password -a "$KEYCHAIN_ACCOUNT" -s "$KEYCHAIN_SERVICE" -w "$PASS" -T "" 2>/dev/null || true
  echo "   âœ… å¯†ç å·²ä¿å­˜åˆ°æœ¬æœº Keychain"
else
  echo "âœ… å·²ä»Ž Keychain è¯»å–å¯†ç "
fi

# 3. å†™å…¥ local.propertiesï¼ˆä¿ç•™å·²æœ‰çš„ sdk.dir ç­‰è¡Œï¼‰
touch "$LOCAL_PROPS"
grep -v "^KEYSTORE\|^KEY_" "$LOCAL_PROPS" > /tmp/_lp_tmp || true
mv /tmp/_lp_tmp "$LOCAL_PROPS"

cat >> "$LOCAL_PROPS" << PROPS

# Release signing (iCloud Drive JKS + Keychain password) â€” auto-generated by setup-signing.sh
KEYSTORE_PATH=$ICLOUD_JKS
KEYSTORE_PASSWORD=$PASS
KEY_ALIAS=$KEYCHAIN_ACCOUNT
KEY_PASSWORD=$PASS
PROPS

echo "âœ… local.properties å·²æ›´æ–°"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸŽ‰ å®Œæˆï¼çŽ°åœ¨å¯ä»¥è¿è¡Œï¼š./gradlew assembleRelease"
echo ""
echo "ðŸ’¡ æç¤ºï¼šå¦‚éœ€é…ç½® GitHub Actions ç­¾åï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤èŽ·å– Secrets å€¼ï¼š"
echo "   base64 -i \"$ICLOUD_JKS\" | pbcopy   # KEYSTORE_BASE64 å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"
echo "   security find-generic-password -a release -s MedLogAndroid-Keystore -w   # KEYSTORE_PASSWORD"
